<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#1565C0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>CBA Field Editor</title>

    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üõ∞Ô∏è</text></svg>">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* RESET & BASE */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; }
        
        body { 
            margin: 0; padding: 0; 
            /* Usa dvh para descontar a barra do navegador no mobile */
            height: 100dvh; 
            width: 100vw;
            display: flex; flex-direction: column; 
            background: #f0f2f5; overflow: hidden; 
        }

        /* HEADER */
        header { 
            background: #1565C0; color: white; height: 50px; flex-shrink: 0;
            display: flex; align-items: center; justify-content: space-between; 
            padding: 0 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 1000;
            padding-top: env(safe-area-inset-top); /* Prote√ß√£o para Notch */
        }
        .app-title { font-weight: 700; font-size: 1rem; display: flex; align-items: center; gap: 8px; }
        .btn-open { background: rgba(255,255,255,0.2); border: none; color: white; padding: 6px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; cursor: pointer; }
        #fileInput { display: none; }

        /* LAYOUT PRINCIPAL */
        #main-container { 
            flex: 1; 
            display: flex; 
            flex-direction: column; /* Mobile first: Um em cima do outro */
            position: relative; 
            overflow: hidden; 
            height: 100%; /* Garante que o container ocupe o espa√ßo restante */
        }

        /* MAPA */
        #map { 
            flex: 1; /* O mapa ocupa todo o espa√ßo que sobrar */
            width: 100%; 
            background: #e5e3df; 
            z-index: 1; 
        }
        #map.crosshair { cursor: crosshair; }

        /* PAINEL INFERIOR (CONTROLES) */
        #controls { 
            /* Altura fixa de 45% da tela vis√≠vel */
            height: 45dvh; 
            min-height: 280px; 
            background: white; 
            box-shadow: 0 -4px 15px rgba(0,0,0,0.1); 
            border-radius: 15px 15px 0 0;
            display: flex; 
            flex-direction: column; 
            z-index: 999;
            position: relative;
        }

        /* √ÅREA DE SCROLL (ONDE FICA A LISTA) */
        .panel-scroll { 
            flex: 1; /* Cresce para ocupar o espa√ßo dispon√≠vel */
            padding: 15px; 
            overflow-y: auto; /* Scroll apenas aqui dentro */
            -webkit-overflow-scrolling: touch;
        }

        /* RODAP√â FIXO (BOT√ïES) */
        .panel-footer {
            flex-shrink: 0; /* Impede que o rodap√© seja esmagado */
            padding: 10px 15px;
            background: white;
            border-top: 1px solid #eee;
            /* Garante que os bot√µes n√£o colem na barra de gesto do iPhone */
            padding-bottom: calc(10px + env(safe-area-inset-bottom)); 
            display: grid;
            grid-template-columns: 1fr 1fr 0.8fr; 
            gap: 10px;
        }

        /* ELEMENTOS VISUAIS */
        .status-bar { font-size: 0.75rem; color: #666; text-align: center; margin-bottom: 10px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; background: #f9f9f9; padding: 4px; border-radius: 4px; }
        
        label { font-size: 0.7rem; font-weight: 700; color: #888; text-transform: uppercase; display: block; margin-bottom: 5px; letter-spacing: 0.5px; }
        
        input[type=range] { width: 100%; margin: 8px 0; height: 4px; background: #ddd; border-radius: 2px; -webkit-appearance: none; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; width: 24px; height: 24px; background: #1565C0; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3); }

        .kpi-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px; background: #f5f7f9; padding: 8px; border-radius: 8px; margin-bottom: 15px; }
        .kpi-item { text-align: center; }
        .kpi-val { font-size: 0.95rem; font-weight: 800; color: #333; display: block; }
        .kpi-lbl { font-size: 0.6rem; color: #888; font-weight: 700; text-transform: uppercase; }

        /* LISTA DE PONTOS */
        #pointList { list-style: none; padding: 0; margin: 0; }
        #pointList li { font-size: 0.8rem; background: #fff; border-bottom: 1px solid #eee; padding: 10px 0; display: flex; justify-content: space-between; align-items: center; }
        .btn-del { color: #d32f2f; font-weight: bold; padding: 5px 15px; cursor: pointer; font-size: 1.2em; }

        /* BOT√ïES PRINCIPAIS */
        .btn-mode { 
            padding: 12px 0; border-radius: 8px; border: none; font-weight: 700; font-size: 0.85rem; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px; 
            cursor: pointer; transition: 0.1s; height: 50px; /* Altura fixa para toque f√°cil */
        }
        
        .mode-alert { background: #fff3e0; color: #e65100; border: 1px solid #ffe0b2; }
        .mode-alert.active { background: #e65100; color: white; border-color: #e65100; }
        
        .mode-info { background: #e3f2fd; color: #1565c0; border: 1px solid #bbdefb; }
        .mode-info.active { background: #1565c0; color: white; border-color: #1565c0; }
        
        .mode-save { background: #2e7d32; color: white; border: none; font-size: 0.9rem; }
        .mode-save:active { transform: scale(0.95); opacity: 0.8; }

        .hint-text { text-align: center; font-size: 0.7rem; color: #888; margin-top: 5px; height: 14px; font-style: italic; }
        .hidden { display: none; }
        
        /* Layout Desktop (Sidebar na esquerda) */
        @media (min-width: 768px) {
            #main-container { flex-direction: row; }
            #controls { width: 350px; height: 100%; border-radius: 0; border-left: 1px solid #ddd; }
        }
    </style>
</head>
<body>

<header>
    <div class="app-title">üõ∞Ô∏è CBA Editor</div>
    <button class="btn-open" onclick="document.getElementById('fileInput').click()">üìÇ Abrir</button>
    <input type="file" id="fileInput" accept=".gpx">
</header>

<div id="main-container">
    <div id="map"></div>
    
    <div id="controls">
        <div class="panel-scroll">
            <div class="status-bar" id="fileName">Nenhum arquivo carregado</div>
            
            <div class="kpi-grid">
                <div class="kpi-item"><span class="kpi-val" id="valDist">0.0</span><span class="kpi-lbl">km</span></div>
                <div class="kpi-item"><span class="kpi-val" id="valEle">0</span><span class="kpi-lbl">m (Up)</span></div>
                <div class="kpi-item"><span class="kpi-val" id="valPts">0</span><span class="kpi-lbl">Pts</span></div>
            </div>

            <label>Recorte da Rota</label>
            <input type="range" id="sStart" min="0" value="0" disabled>
            <input type="range" id="sEnd" min="0" value="100" disabled>

            <div class="hint-text" id="modeMsg">...</div>
            
            <label style="margin-top:15px;">Ocorr√™ncias</label>
            <ul id="pointList"></ul>
            <div style="text-align:center; color:#ccc; font-size:0.7rem; margin-top:10px;" id="emptyMsg">Lista vazia</div>
        </div>

        <div class="panel-footer">
            <button id="btnAlert" class="btn-mode mode-alert" onclick="toggleMode('alert')">
                <span>‚ö†Ô∏è</span> Alerta
            </button>
            <button id="btnInfo" class="btn-mode mode-info" onclick="toggleMode('info')">
                <span>‚ÑπÔ∏è</span> Info
            </button>
            <button class="btn-mode mode-save" onclick="downloadKML()">
                <span>üíæ</span> Salvar
            </button>
        </div>
    </div>
</div>

<div class="hidden">
    <canvas id="chartCanvas" width="320" height="150"></canvas>
    <input type="file" id="imgUpload" accept="image/*">
</div>

<script>
    let map, fullLine, activeLine, startMarker, endMarker;
    let gpxData = []; 
    let customPoints = []; 
    let currentMode = null; 
    let tempPoint = null; 

    function initMap() {
        map = L.map('map', {zoomControl: false}).setView([-14.235, -51.925], 4);
        L.control.zoom({position: 'topleft'}).addTo(map);
        L.tileLayer('http://{s}.google.com/vt/lyrs=s,h&x={x}&y={y}&z={z}', { maxZoom: 20, subdomains: ['mt0','mt1','mt2','mt3'] }).addTo(map);

        fullLine = L.polyline([], {color: 'gray', opacity: 0.4, weight: 3}).addTo(map);
        activeLine = L.polyline([], {color: '#00FFFF', weight: 5}).addTo(map);
        startMarker = L.marker([0,0], {icon: createIcon('#00e676')}).addTo(map);
        endMarker = L.marker([0,0], {icon: createIcon('#ff1744')}).addTo(map);
    }

    function createIcon(color) {
        return L.divIcon({ className: 'custom-icon', html: `<div style="background:${color};width:14px;height:14px;border:2px solid white;border-radius:50%;box-shadow:0 0 4px rgba(0,0,0,0.5);"></div>` });
    }

    document.getElementById('fileInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;
        document.getElementById('fileName').innerText = file.name;
        
        const reader = new FileReader();
        reader.onload = function(e) {
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(e.target.result, "text/xml");
            const trkpts = xmlDoc.getElementsByTagName("trkpt");
            gpxData = [];
            let distTotal = 0;

            for (let i = 0; i < trkpts.length; i++) {
                const lat = parseFloat(trkpts[i].getAttribute("lat"));
                const lon = parseFloat(trkpts[i].getAttribute("lon"));
                const ele = parseFloat(trkpts[i].getElementsByTagName("ele")[0]?.textContent || 0);
                if (i > 0) {
                    const prev = gpxData[i-1];
                    distTotal += calcDistance(prev.lat, prev.lon, lat, lon);
                }
                gpxData.push({lat, lon, ele, dist: distTotal});
            }
            if (gpxData.length > 0) setupEditor();
        };
        reader.readAsText(file);
    });

    function calcDistance(lat1, lon1, lat2, lon2) {
        const R = 6371; 
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
        return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
    }

    function setupEditor() {
        const sStart = document.getElementById('sStart');
        const sEnd = document.getElementById('sEnd');
        sStart.max = gpxData.length - 1; sStart.value = 0; sStart.disabled = false;
        sEnd.max = gpxData.length - 1; sEnd.value = gpxData.length - 1; sEnd.disabled = false;

        fullLine.setLatLngs(gpxData.map(p => [p.lat, p.lon]));
        map.fitBounds(fullLine.getBounds(), {padding: [20, 20]});
        updateMap();
    }

    function updateMap() {
        const i = parseInt(document.getElementById('sStart').value);
        let j = parseInt(document.getElementById('sEnd').value);
        if (i >= j) { j = i + 1; document.getElementById('sEnd').value = j; }
        
        const slice = gpxData.slice(i, j + 1);
        const latlngs = slice.map(p => [p.lat, p.lon]);
        activeLine.setLatLngs(latlngs);
        startMarker.setLatLng(latlngs[0]);
        endMarker.setLatLng(latlngs[latlngs.length - 1]);

        const dist = slice[slice.length-1].dist - slice[0].dist;
        let eleGain = 0;
        for(let k=1; k < slice.length; k++) { if(slice[k].ele > slice[k-1].ele) eleGain += slice[k].ele - slice[k-1].ele; }

        document.getElementById('valDist').innerText = dist.toFixed(2);
        document.getElementById('valEle').innerText = eleGain.toFixed(0);
        document.getElementById('valPts').innerText = slice.length;
    }

    document.getElementById('sStart').addEventListener('input', updateMap);
    document.getElementById('sEnd').addEventListener('input', updateMap);

    function toggleMode(mode) {
        const btnAlert = document.getElementById('btnAlert');
        const btnInfo = document.getElementById('btnInfo');
        const msg = document.getElementById('modeMsg');
        
        if (currentMode === mode) {
            currentMode = null;
            btnAlert.classList.remove('active'); btnInfo.classList.remove('active');
            msg.innerText = "...";
            L.DomUtil.removeClass(map.getContainer(), 'leaflet-crosshair');
        } else {
            currentMode = mode;
            L.DomUtil.addClass(map.getContainer(), 'leaflet-crosshair');
            if(mode === 'alert') { btnAlert.classList.add('active'); btnInfo.classList.remove('active'); msg.innerText = "Toque na rota para PERIGO ‚ö†Ô∏è"; }
            else { btnInfo.classList.add('active'); btnAlert.classList.remove('active'); msg.innerText = "Toque na rota para INFO ‚ÑπÔ∏è"; }
        }
    }

    initMap();
    map.on('click', function(e) {
        if (!currentMode || gpxData.length === 0) return;
        let nearest = null; let minDist = Infinity;
        for (const p of gpxData) {
            const d = Math.pow(p.lat - e.latlng.lat, 2) + Math.pow(p.lon - e.latlng.lng, 2);
            if (d < minDist) { minDist = d; nearest = p; }
        }
        if (nearest) {
            const label = prompt("Descri√ß√£o:", currentMode === 'alert' ? "Buraco" : "Nota");
            if (label) {
                tempPoint = { ...nearest, label: label, type: currentMode, image: null };
                if (confirm("Adicionar foto?")) document.getElementById('imgUpload').click();
                else addPoint(tempPoint);
            }
        }
        toggleMode(currentMode);
    });

    document.getElementById('imgUpload').addEventListener('change', function(e) {
        if (this.files && this.files[0] && tempPoint) {
            const reader = new FileReader();
            reader.onload = function(evt) {
                resizeImage(evt.target.result, function(res) { tempPoint.image = res; addPoint(tempPoint); });
            };
            reader.readAsDataURL(this.files[0]);
        }
    });

    function resizeImage(base64Str, callback) {
        const img = new Image();
        img.src = base64Str;
        img.onload = function() {
            const canvas = document.createElement('canvas');
            const MAX_W = 600; const scale = MAX_W / img.width;
            canvas.width = MAX_W; canvas.height = img.height * scale;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            callback(canvas.toDataURL('image/jpeg', 0.6));
        }
    }

    let markersLayer = L.layerGroup().addTo(map);
    function addPoint(p) { customPoints.push(p); renderPoints(); }
    function removePoint(i) { customPoints.splice(i, 1); renderPoints(); }

    function renderPoints() {
        const list = document.getElementById('pointList'); list.innerHTML = '';
        markersLayer.clearLayers();
        
        if(customPoints.length > 0) document.getElementById('emptyMsg').style.display = 'none';
        else document.getElementById('emptyMsg').style.display = 'block';

        customPoints.forEach((p, idx) => {
            const iconChar = p.type === 'alert' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
            const imgChar = p.image ? 'üì∑' : '';
            list.innerHTML += `<li><span>${iconChar} ${p.label} ${imgChar}</span><span class="btn-del" onclick="removePoint(${idx})">‚úï</span></li>`;
            
            const color = p.type === 'alert' ? '#ef6c00' : '#1565c0';
            const icon = L.divIcon({ className: 'c-pin', html: `<div style="background:${color};width:16px;height:16px;border:2px solid white;border-radius:50%;box-shadow:0 0 4px black;"></div>` });
            L.marker([p.lat, p.lon], {icon: icon}).addTo(markersLayer);
        });
    }

    async function downloadKML() {
        if (gpxData.length === 0) return alert("Abra um GPX primeiro.");
        
        const i = parseInt(document.getElementById('sStart').value);
        const j = parseInt(document.getElementById('sEnd').value);
        const slice = gpxData.slice(i, j + 1);

        const ctx = document.getElementById('chartCanvas').getContext('2d');
        ctx.clearRect(0,0,320,150);
        if(window.myChart) window.myChart.destroy();
        window.myChart = new Chart(ctx, {
            type: 'line',
            data: { labels: slice.map(p => p.dist.toFixed(1)), datasets: [{ data: slice.map(p => p.ele), borderColor: '#1565C0', backgroundColor: 'rgba(33,150,243,0.2)', borderWidth: 2, fill: true, pointRadius: 0 }] },
            options: { animation: false, responsive: false, scales: {x:{display:false}, y:{ticks:{font:{size:10}}}}, plugins: {legend:{display:false}} }
        });
        await new Promise(r => setTimeout(r, 200));
        const imgChart = document.getElementById('chartCanvas').toDataURL('image/png');

        const coords = slice.map(p => `${p.lon},${p.lat},${p.ele}`).join(' ');
        const distTotal = (slice[slice.length-1].dist - slice[0].dist).toFixed(2);
        
        let pointsXML = '';
        customPoints.forEach(p => {
            const style = p.type === 'alert' ? 'iconAlert' : 'iconInfo';
            const img = p.image ? `<br><img src="${p.image}" style="width:250px; border:1px solid #ccc;">` : '';
            pointsXML += `<Placemark><name>${p.label}</name><styleUrl>#${style}</styleUrl><description><![CDATA[<h3>${p.label}</h3>${img}]]></description><Point><coordinates>${p.lon},${p.lat},${p.ele}</coordinates></Point></Placemark>`;
        });

        const kml = `<?xml version="1.0" encoding="UTF-8"?>
<kml xmlns="http://www.opengis.net/kml/2.2">
  <Document>
    <name>Rota CBA ${distTotal}km</name>
    <Style id="lineCyan"><LineStyle><color>ffFFFF00</color><width>5</width></LineStyle></Style>
    <Style id="iconAlert"><IconStyle><scale>1.1</scale><Icon><href>http://maps.google.com/mapfiles/kml/shapes/caution.png</href></Icon></IconStyle></Style>
    <Style id="iconInfo"><IconStyle><scale>1.1</scale><Icon><href>http://maps.google.com/mapfiles/kml/pushpin/blue-pushpin.png</href></Icon></IconStyle></Style>
    <Placemark>
        <name>Tra√ßado - ${distTotal}km</name>
        <styleUrl>#lineCyan</styleUrl>
        <description><![CDATA[
            <div style="font-family:Arial; width:300px;">
                <h3 style="color:#1565C0;">Resumo</h3>
                <p>Dist√¢ncia: <b>${distTotal} km</b></p>
                <img src="${imgChart}" style="width:100%;">
            </div>
        ]]></description>
        <LineString><tessellate>1</tessellate><coordinates>${coords}</coordinates></LineString>
    </Placemark>
    <Folder><name>Pontos</name>${pointsXML}</Folder>
  </Document>
</kml>`;
        const blob = new Blob([kml], {type: 'application/vnd.google-earth.kml+xml'});
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `Rota_CBA_${distTotal}km.kml`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
</script>
</body>
</html>
